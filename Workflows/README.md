The structure of the folder is as follows:
- Workflows
    - Config - per model  : Model configuration files
    - Config_snakemake : Snakemake configuration files
    - data_catalogs : The data catalogs used for model building and used by HydroMT
    - scripts
        - model_building : Scripts used to build the models
        - preprocessing : Scripts used for preprocessing of data, updating models etc.
        - postprocessing : Scripts used for postprocessing of model results

There are specific environment to run the different workflows, as can be found in *pixi.toml*

Scripts to execute the Workflows on Linux can be found in the *Workflows\00_execution_script_examples* folder 


## **Workflows**

Seven snakemake workflow files are present. All workflows work both on Linux as well as on Windows. All snakemake workflows use the same config yml file: *config_snakemake/config_general_MZB.yml*. All data that is necessary to run the workflows is open source and can be found through the links in the data catalogs or are self generated and can be found in the Data folder.

- [Workflows](#workflows)
- **snakefile_sfincs_build.smk**: This workflow builds a SFINCS model without adding any forcing yet. The workflow consists of just one rule.
- **snakefile_wflow.smk**: This workflow builds a wflow model, using the SFINCS region as input. Gauges are added on the SFINCS inflow points, in order to generate output at the correct locations. Precipitation forcing is added based on the event start and end time. First, the wflow model is warmed up for a period of 1 year, with daily ERA5 data. The event itself is run with ERA5 hourly precipitation and tmeperature forcing data as given in the snakemake configuration file. Both factual and counterfactual precipitation can be provided as input.
- **snakefile_wflow_30yr.smk**: This workflow builds a 30-year long wflow model, ending at the start of the TC event, using the wflow base model as input. The bankfull discharge (2-year return period) is based on this 30-year long simulation and removed from the wflow generated discharge for the event, before added as discharge boundary condition to SFINCS.The remain incoming discharge represents the out of banks discharge, thereby removing the need to burn in an (unknown) river conveyance in the DEM. For this purpose, the same gauges as the wflow model for the event are used, in order to generate output at the correct locations. Precipitation forcing is added based on the event start time and exactly 30 years prior. The 30-year wflow model is run with daily ERA5 data for precipitation and temperature.
- **snakefile_dfm.smk**/**snakefile_dfm_cluster.smk**: This workflow creates a dfm base model on windows or linux (_cluster) and updates it by adding forcing data and running the model simulations. Afterwards, wave setup results from a SFINCS-SnapWave simulation is added to the DFM output. The output is added to a data catalog which can be used as SFINCS waterlevel forcing. Both factual and counterfactual sea level and wind speed can be provided as input.
- **snakefile_sfincs_update.smk**: This workflow updates the SFINCS model by adding forcing data and running the model simulations. It handles the addition of meteorological, coastal and discharge forcing data; executes the model, and generates the output. Both factual and counterfactual precipitation, sea level and wind speed can be provided as input.
- **snakefile_all_wflow_sfincs.smk**: This workflow combines the wflow and sfincs into one large workflow. Combining all workflow is not possible due to conflicting packages and the need for one overarching pixi environment. You can use this snakefile instead of the one mentioned shortly. The sequence of the workflows are: 
snakefile_sfincs_build.smk > snakefile_wflow.smk > snakefile_sfincs_update.smk
- **snakefile_fiat.smk**: This workflow builds and runs the Delft-FIAT model to estimate flood damage, based on the floodmap generated by the SFINCS simulations. 
In the section below, the different workflows are described:



## Workflow --- snakefile_sfincs_build.smk ---

This workflow builds a SFINCS model without adding any forcing yet. The workflow consists of just one rule.

#### Rule: make_base_model_sfincs
- **Script**: `04_scripts/model_building/sfincs/setup_sfincs_base.py`
- **Input**: `05_config_models/02_sfincs/sfincs_base_build.yml`
- **Output**: SFINCS model for the region (bounding box defined in `01_config_snakemake/config_general_MZB.yml`).
- **Description**: This rule creates the SFINCS model using the bbox given in the snakemakeThe model domain is based on the bounding box as given in the *01_config_snakemake/config_general_MZB.yml* file.
Further options for building the model are given in the *05_config_models/02_sfincs/sfincs_base_build.yml* input file.
The bounding box is then used to find all intersecting subbasins (hydroAtlas level 12). These intersecting subbasins form the model region. Also, the model region extents to the -5 m depth contour line (over the ocean - based on bathymetry). 



## Workflow --- snakefile_wflow.smk/snakefile_wflow_30yr ---

First, use this workflow to only run the first rule **make_base_model_wflow**. This rule builds a wflow model, using the SFINCS region as input. Gauges are added on the SFINCS inflow points, in order to generate output at the correct locations. Running one rule from a snakefile can be done by making sure the output from that one rule is the input for the **all_wflow** rule (*see line 60 in snakefile_wflow.smk*). Afterwards, one should first run the  **snakefile_wflow_30yr.smk** file *once* to get the data to calculate the bnkfull discharge for the correct gauges. 

Afterwards, continue running the **snakefile_wflow.smk** (*see line 60 in snakefile_wflow.smk*). Precipitation forcing is added based on the event start and end time, all from the *01_config_snakemake/config_general_MZB.yml*. First, the model is warmed up for a period of 1 year, with daily ERA5 data. The event itself is run with the forcing data as given in the snakemake config file (*01_config_snakemake/config_general_MZB.yml*). Lastly, the bankfull discharge calculated using the snakefile_wflow_30yr.smk workflow is removed from the wflow discharge to correct for missing river bathymetry.

## Workflow --- snakefile_wflow.smk ---
#### Rule: make_base_model_wflow
- **Script**: `04_scripts/model_building/sfincs/setup_wflow_base.py`
- **Input**: 
  - `05_config_models/01_wflow/config_wflow.yml`
  - `{SFINCS_MODEL_DIR}/gis/region.geojson`
  - `{SFINCS_MODEL_DIR}/gis/src.geojson`
- **Output**: wflow model for the SFINCS region.
- **Description**: This rule creates the wflow model  using the SFINCS region 
Further options for building the model are given in the input yml file. The model is created for the entire upstream basin of the SFINCS region.
The model is created on the P-drive in the *p:\11210471-001-compass\02_Models* folder

-------------------------------------------------------------------------------------------------------------------------------------------
### Workflow --- snakefile_wflow_30yr.smk ---
#### Rule: update_forcing_wflow_warmup
- **Script**: `04_scripts/model_building/wflow/update_forcing_wflow_warmup.py`
- **Input**:
  - `toml_file`
  - `staticmaps`
- **Output**: Updated wflow model with ERA5 forcing data.
- **Description**: This rule uses the wflow base model and updates it with daily forcing data from ERA5. The start time is 30 years before the start time of the event (given in the snakemake config yml file) and the end time is 2 days before the event. Make sure to set the correct output folder in the snake file

#### Rule: run_wflow_warmup
- **Input**:
  - `inmaps.nc` (from warmup run)
  - `toml_file` (from warmup run)
- **Output**: wflow 30 years warmup run output.
- **Description**: This rule runs the wflow 30 years warmup model.
-------------------------------------------------------------------------------------------------------------------------------------------

### Workflow --- snakefile_wflow.smk (continued) ---
#### Rule: update_forcing_wflow_warmup
- **Script**: `04_scripts/model_building/wflow/update_forcing_wflow_warmup.py`
- **Input**:
  - `toml_file`
  - `staticmaps`
- **Output**: Updated wflow model with ERA5 forcing data.
- **Description**: This rule uses the wflow base model and updates it with daily forcing data from ERA5. The start time is 1 year before the start time of the event (given in the snakemake config yml file) and the end time is 2 days before the event. Make sure to set the correct output folder in the snake file

#### Rule: update_forcing_wflow_event
- **Script**: `04_scripts/model_building/wflow/update_forcing_wflow_event.py`
- **Input**:
  - `toml_file`
  - `staticmaps`
- **Output**: Updated wflow base model for the event with the configured forcing data.
- **Description**: This rule uses the wflow base model and updates it with forcing data as configured in the snakemake config file. The start time is 2 days before the date in the config file and it uses the initial state from the warmup run. Make sure to set the correct output folder in the snake file

#### Rule: run_wflow_warmup
- **Input**:
  - `inmaps.nc` (from warmup run)
  - `toml_file` (from warmup run)
- **Output**: wflow warmup run output.
- **Description**: This rule runs the wflow warmup model. The final state is saved into the folder of the 'event' run. 

#### Rule: run_wflow_event
- **Input**:
  - `inmaps.nc` (from event run)
  - `toml_file` (from event run)
  - `instates.nc` (from warmup run)
- **Output**: wflow event run output, saved as `output_scalar.nc`.
- **Description**: This rule runs the wflow event run. Output is saved as *output_scalar.nc*

#### Rule: postprocess_discharge
- **Script**: `04_scripts/postprocessing/wflow/calculate_and_remove_qbankfull.py`
- **Input**:
  - `output_scalar.nc` (from event run)
  - `output_scalar.nc` (from wflow 30yr run)
- **Params**:
  - `wflow_root_forcing_30yr` (from snake rule)
  - `wflow_root_forcing` (from snake rule)
  - `get_datacatalog` (from snake rule)
- **Output**: wflow event run output with the bankful discharge substracted, saved as `wflow_dis_no_qbankfull.csv`.
- **Description**: This rule removes the estimated bankful discharhe from the 30 yr wflow run from the event discharge, to correct for missing rver bathymetry. Output is saved as *wflow_dis_no_qbankfull.csv*, which is the input for the SFINCS event run.



##  Workflow --- snakefile_dfm.smk ---

This workflow creates a D-Flow FM (dfm) base model and updates it by adding forcing data and running the model simulations. Subsequently, the wave setup resulting from a SFINCS-SnapWave simulation is added to the D-Flow FM output. Lastly, the combined D-Flow FM-SnapWave output is added to a data catalog which can be used as SFINCS waterlevel forcing.

#### Rule: make_model_dfm_base
- **Script**: `04_scripts/model_building/dfm/setup_dfm_base.py`
- **Params**:
  - `bbox_dfm` (from config file)
  - `bbox_output` (from config file)
  - `data_cat` (from snake file)
- **Output**: D-Flow FM (DFM) base model configuration, saved as multiple files in the base model folder:
  - `geometry` folder with base model grid figures
  - `pli_file.pli`
  - `illigalcells.pol`
  - `grid_network.nc`
  - `tide_{bathy}.bc`
  - `L*.pli` where * is a number, depending on how many boundary lines there are
  - `ext_file_new.ext`
- **Description**: This rule makes generates and refines base model grid and adds boundary conditions from a tidal model.

#### Rule: make_dfm_model_event
- **Script**: `04_scripts/model_building/dfm/setup_dfm_event.py`
- **Input**: 
  - `ext_file_new.ext` (from the base model)
  - (and all other files in the base model folder, which are copied inside the script to the event folder)
- **Params**:
  - `dir_base_model` (from make_model_dfm_base rule)
  - `start_time` (from config file)
  - `end_time` (from config file)
  - `bbox_dfm` (from config file)
  - `bbox_output` (from config run)
  - `dfm_obs_file` (from config file)
  - `verif_points_file` (from config file)
  - `data_cat` (from snake file)
  - `dimrset` (from Deltares dfm directory)
  - `uniformwind` (from data directory)
  - `era5wind` (download and tore in data dir)
  - `model_name` (from snake rule)
- **Output**: 
  - `geometry` folder with base grid Ã¡nd event model figures
  - `{model_name}.mdu`
  - `ext_file_old.ext`
  - `dimr_config.xml`
  - `run_singularity_h7.sh` (if run on linux)
  - `run_parallel.bat` (if run on windows)
- **Description**: This rule copies the base model configuration and adds the TC meteo forcing. It also set the model output points (through an obs file) and generates the files required to run the model (mdu, dimr, bat and sh)

#### Rule: run_dfm
- **Script**: `04_scripts/model_building/dfm/setup_dfm_event.py`
- **Input**: 
  - `run_singularity_h7.sh` (if run on linux)
  - `run_parallel.bat` (if run on windows)
  - (and all other files in the event model folder, needed for model execution)
- **Run**:
  - Runs the batch file depending on the system that is used
- **Output**: 
  - `output/settings_0000_his.nc` (needed as sfincs water level forcing)
  - other output files, not needed for sfincs and therefore not included in the snake rule
- **Description**: This rule runs the dfm event model configuration, possible on windows and linux systems. It generates an output folder containing a his.nc, map.nc and .dia file. 

#### Rule: add_waves_and_output_to_catalog
- **Script**: `04_scripts/postprocessing/dfm/output_to_catalog_add_waves.py`
- **Input**: 
  - `output/settings_0000_his.nc` (from the event model directory)
- **Params**:
  - `model_name` (from snake rule)
  - `coast_data_cat` (from snake rule)
  - `cf_data_cat` (from snake rule)
  - `root_dir` (from snake rule, differs for windows or linux)
  - `use_waves` (from snake rule)
  - `wave_output` (from snake rule, handle to data catalog)
  - `start_time` (from snake rule)
  - `end_time` (from snake rule)
- **Output**: 
  - `done_file` tracks whether the cf_data_cat is updated
- **Description**: This rule adds wave setup from SnapWave to the D-Flow FM (DFM) his.nc output and adds it to the CF data catalog, to be used as water level forcing for the SFINCS model. A 'done_file' is used for Snakemake to track whether the data catalog has been updated, but has no other purpose.



## Workflow --- snakefile_sfincs_update.smk ---

This workflow updates the SFINCS model by adding forcing data and running the model simulations. It handles the addition of both meteorological and wflow forcing data, executes the model, and generates the output.

#### Rule: add_forcing_coastal_meteo_sfincs
- **Script**: `04_scripts/model_building/sfincs/update_sfincs_coastal_forcing.py`
- **Input**: 
  - `msk_file`
- **Params**:
  - `dfm_output` (output from D-Flow FM model)
  - `wind_forcing` (wind forcing from snake config file)
  - and more...
- **Output**: 
  - `bzs file` (water level boundary points)
- **Description**: This rule adds meteorological and coastal water level forcing to the SFINCS model.

#### Rule: update_dis_forcing_sfincs
- **Script**: `04_scripts/model_building/sfincs/update_sfincs_dis_forcing.py`
- **Input**: 
  - `bzs_file` (water level boundary points)
  - `wflow_output` (not used in this rule but necessar for wflow to compelte before starting sfincs)
  - `wflow_dis_no_bankfull` (wflow output corrected for bankfull discharge)
- **Output**: 
  - `dis_file` (discharge input as SFINCS file format)
- **Description**: This rule updates the SFINCS model by adding forcing data derived from wflow outputs. The `.dis` file is created, adding the discharge from wflow as forcing for SFINCS.

#### Rule: `run_sfincs_model`
- **Script**: N/A (The model is executed via a subprocess or Docker)
- **Input**: 
  - `dis_file` (discharge input as SFINCS file format)
- **Output**: 
  - `sfincs_map.nc` (spatial output of SFINCS)
  - `sfincs_his.nc` (timeseries output of SFINCS)
- **Description**: This rule runs the SFINCS model with the updated `.dis` file. Depending on the operating system, the model is executed either via a subprocess (on Windows) or through Docker (on Linux).

#### Rule: `sfincs_plot_floodmap`
- **Script**: `04_scripts/postprocessing/sfincs/sfincs_postprocess.py`
- **Input**: 
  - `sfincs_map.nc` (spatial output of SFINCS)
  - `sfincs_his.nc` (timeseries output of SFINCS)
- **Output**: 
  - `sfincs_basemap.png` (SFINCS basemap)
  - `floodmap.tif` (floodmap necessary for FIAT)
- **Description**: This rule generates the final flood map visualization from the model outputs (`sfincs_map.nc` and `sfincs_his.nc`). The postprocessing script is used to produce the flood map (necessary for fiat) as well as some other images.



## Workflow --- snakefile_fiat.smk ---

This workflow build and runs a Delft-FIAT model using hydromt-fiat and a config file. This workflow can be run using the pixi environment compass-fiat. After activating the environment, make sure to add hydromt-fiat using the command: `pip install "hydromt_fiat @ git+https://github.com/Deltares/hydromt_fiat.git"`, or simply use the 00_execution_examples/run_snakemake_fiat_workflow_h7.sh batch file.

#### Rule: `build_fiat_model`
- **Script**: `04_scripts/model_building/fiat/setup_fiat.py`
- **Input**: 
  - `floodmap.tif ` (output of SFINCS)
- **Params**:
  - `dir_run_with_forcing` (sfincs model directory)
  - `datacat_fiat` (data catalog for fiat: `03_data_catalogs/datacatalog_fiat.yml`)
  - `model_folder` (folder to store the fiat model)
  - `continent` (continent of case study area as defined in `01_config_snakemake/config_general_MZB.yml`)
  - `country` (continent of case study area as defined in `01_config_snakemake/config_general_MZB.yml`)
  - `config` (fiat config file as stated in the `01_config_snakemake/config_general_MZB.yml`)
- **Output**: 
  - `settings.toml` (setting file for fiat)
- **Description**: This rule builds the Delft-FIAT model based on the floodmap from SFINCS and the data from the datacatalog_fiat.yml. 

#### Rule: `run_fiat_model`
- **Script**: N/A (The model is executed via a subprocess or Docker)
- **Input**: 
  - `settings.toml` (setting file for fiat)
- **Output**: 
  - `spatial.fgb` (fiat output after running the model)
- **Description**: This rule runs the Delft'FIAT model with the `settings.toml` file. Depending on the operating system, the model is executed either via a subprocess (on Windows) or through Docker (on Linux).


---
