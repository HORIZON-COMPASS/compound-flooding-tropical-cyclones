### Import some useful python libraries
import os
from snakemake.io import Wildcards

# Parsing the config file
dir_run = config['dir_runs']

def get_argbbox(wildcards):
    return config['bbox']

rule all:
    input:
        expand(("{dir_allruns}"+"/sfincs_"+"{runname}"+"/sfincs_map.nc"), dir_allruns=config['dir_runs'], runname=config['runname']),
        expand(("{dir_allruns}"+"/sfincs_"+"{runname}"+"/sfincs_his.nc"), dir_allruns=config['dir_runs'], runname=config['runname'])

rule make_base_model:
    params:
        dir_run = "{dir_allruns}"+"/sfincs_"+"{runname}",
        rmfile = "{dir_allruns}"+"/sfincs_"+"{runname}/"+"hydromt_data.yml",
        arg_bbox = get_argbbox
    output: 
        msk_file = "{dir_allruns}"+"/sfincs_{runname}"+"/sfincs.msk"
    shell:
        'hydromt build sfincs {params.dir_run} --region {bbox: {params.arg_bbox}} -i sfincs_base_build.yml --force-overwrite -v && del {params.rmfile}'

rule add_forcing:
    input:
        msk_file = "{dir_allruns}"+"/sfincs_"+"{runname}"+"/sfincs.msk"
    params:
        dir_run = "{dir_allruns}"+"/sfincs_"+"{runname}",
        forcing_yml = 'sfincs_"+ {runname} +"_forcing.yml'
    output:
        bzs_file = "{dir_allruns}"+"/sfincs_"+"{runname}"+"/sfincs.bzs" 
    shell:
        'hydromt update sfincs {params.dir_run} -i {params.forcing_yml} -v'

rule add_batchfile:
    input:
        bzs_file = "{dir_allruns}"+"/sfincs_"+"{runname}"+"/sfincs.bzs" 
    params:
        dir_run = "{dir_allruns}"+"/sfincs_"+"{runname}"
    output:
        ("{dir_allruns}"+"/sfincs_"+"{runname}"+"/run_sfincs.bat")
    script:
        'add_batchfile.py'

rule run_sfincs_model:
    input:
        batchfile = "{dir_allruns}"+"/sfincs_"+"{runname}"+"/run_sfincs.bat"
    params:
        dir_run = "{dir_allruns}"+"/sfincs_"+"{runname}"
    output:
        mapout = "{dir_allruns}"+"/sfincs_"+"{runname}"+"/sfincs_map.nc",
        hisout = "{dir_allruns}"+"/sfincs_"+"{runname}"+"/sfincs_his.nc"     
    shell:
        'cd {params.dir_run} && run_sfincs.bat'